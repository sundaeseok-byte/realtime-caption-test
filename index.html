<!doctype html>

<html lang="ko">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>ì‹¤ì‹œê°„ í•œêµ­ì–´ ìë§‰ (ì‹¬í”Œ + ê¸€ìí¬ê¸°)</title>

  <style>

    :root { --fs: 22px; }

    body { margin:0; background:#111; color:#eee; font:var(--fs)/1.6 "Noto Sans KR",sans-serif; }

    header { padding:10px; border-bottom:1px solid #444; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    button { padding:6px 14px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }

    button.primary { background:#4da3ff; color:#000; }

    button.danger  { background:#ff4d6d; color:#000; }

    #screen { padding:12px; height:80vh; overflow-y:auto; white-space:pre-wrap; }

    #state { margin-left:auto; color:#aaa; }

    .group { display:flex; gap:6px; align-items:center; }

    .pill  { font-size:12px; color:#9aa3ad; }

  </style>

</head>

<body>

  <header>

    <button id="toggle" class="primary">ğŸ™ï¸ ì‹œì‘</button>

    <button id="clear">ğŸ§¹ ì§€ìš°ê¸°</button>

    <button id="copy">ğŸ“‹ ë³µì‚¬</button>



    <div class="group" aria-label="ê¸€ì í¬ê¸° ì¡°ì ˆ">

      <button id="smaller" title="ê¸€ì ì‘ê²Œ">Aâˆ’</button>

      <button id="bigger"  title="ê¸€ì í¬ê²Œ">A+</button>

      <span id="fsLabel" class="pill"></span>

    </div>



    <span id="state">ëŒ€ê¸°</span>

  </header>



  <div id="screen"></div>



<script>

(() => {

  // ===== ê¸€ì í¬ê¸° ì¡°ì ˆ =====

  const FONT_MIN = 16, FONT_MAX = 64, STEP = 2;

  const fsLabel = document.getElementById("fsLabel");

  let curFs = Number(localStorage.getItem("subtitle_fs_px") || 22);

  function applyFs(px){

    curFs = Math.min(FONT_MAX, Math.max(FONT_MIN, px));

    document.documentElement.style.setProperty("--fs", curFs + "px");

    fsLabel.textContent = `${curFs}px`;

    localStorage.setItem("subtitle_fs_px", String(curFs));

  }

  applyFs(curFs);

  document.getElementById("smaller").onclick = () => applyFs(curFs - STEP);

  document.getElementById("bigger").onclick  = () => applyFs(curFs + STEP);



  // ===== ìŒì„± ì¸ì‹ =====

  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!Rec) {

    document.body.innerHTML = "<p style='padding:16px'>âŒ í¬ë¡¬/ì‚¼ì„± ì¸í„°ë„· ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>";

    return;

  }



  const r = new Rec();

  r.lang = "ko-KR";

  r.continuous = true;

  r.interimResults = true;



  let recognizing = false;

  const toggle = document.getElementById("toggle");

  const clearBtn = document.getElementById("clear");

  const copyBtn = document.getElementById("copy");

  const state = document.getElementById("state");

  const screen = document.getElementById("screen");



  // ëˆ„ì /í‘œì‹œ ìƒíƒœ

  let finalText = "";          // í™•ì • ëˆ„ì  (í•œ ì¤„ë¡œ ì´ì–´ì“°ê¸°, ë ê³µë°± 1ê°œ ìœ ì§€)

  let lastShown = "";          // ë§ˆì§€ë§‰ í™”ë©´ì— í‘œì‹œëœ ì „ì²´ ë¬¸ìì—´

  let debounceTimer = null;    // í™•ì • ë””ë°”ìš´ìŠ¤ íƒ€ì´ë¨¸

  let pendingFinal = "";       // ë””ë°”ìš´ìŠ¤ ëŒ€ê¸° ì¤‘ì¸ ìµœì‹  final í…ìŠ¤íŠ¸



  // íŒŒë¼ë¯¸í„° (í•„ìš” ì‹œ ì¡°ì •)

  const DEBOUNCE_MS   = 900;   // ë§ì´ ë” ì´ì–´ì§ˆì§€ 0.9ì´ˆ ê¸°ë‹¤ë ¸ë‹¤ê°€ í•œ ë²ˆë§Œ í™•ì •

  const FINAL_DEDUP_MS= 700;   // ê°™ì€ finalì´ ì—°ë‹¬ì•„ ì˜¤ë©´ 0.7ì´ˆ ë‚´ì—” ë¬´ì‹œ

  const MIN_DELTA     = 3;     // ìƒˆë¡œ ëŠ˜ì–´ë‚˜ëŠ” ê¼¬ë¦¬(delta)ê°€ 3ì ë¯¸ë§Œì´ë©´ ë¶™ì´ì§€ ì•ŠìŒ



  // ì§§ì€ ì‹œê°„ ì¤‘ë³µ ì°¨ë‹¨ìš©

  let lastFinalNorm = "";

  let lastFinalAt   = 0;



  function norm(s){

    return (s||"")

      .replace(/\s+/g," ")

      .replace(/[.,!?â€¦ï¼ï¼Ÿã€‚~]+$/g,"")

      .trim()

      .toLowerCase();

  }



  // prevì˜ ëê³¼ newSegì˜ ì•ì´ ê²¹ì¹˜ë©´ ê²¹ì¹¨ì„ ì œì™¸í•œ ê¼¬ë¦¬ë§Œ ë°˜í™˜

  function deltaAppend(prev, newSeg){

    if (!newSeg) return "";

    const max = 120;

    const tail = prev.slice(-max);

    const head = newSeg.slice(0, max);

    let k = Math.min(tail.length, head.length);

    while (k > 0) {

      if (tail.endsWith(head.slice(0, k))) break;

      k--;

    }

    return newSeg.slice(k);

  }



  function setScreen(text){

    if (text === lastShown) return;

    screen.textContent = text;

    lastShown = text;

    screen.scrollTop = screen.scrollHeight;

  }



  function commitFinal(txt){

    const clean = (txt || "").trim();

    const delta = deltaAppend(finalText, clean);

    if (delta.length >= MIN_DELTA) {

      finalText = (finalText + delta).replace(/\s*$/,"") + " ";

    }

    pendingFinal = "";

    setScreen(finalText);

  }



  r.onresult = (e) => {

    let interim = "";

    for (let i=e.resultIndex; i<e.results.length; i++) {

      const raw = e.results[i][0].transcript;

      if (e.results[i].isFinal) {

        const now = performance.now();

        const n = norm(raw);

        if (n && n === lastFinalNorm && (now - lastFinalAt) < FINAL_DEDUP_MS) continue;

        lastFinalNorm = n; lastFinalAt = now;



        pendingFinal = raw;

        if (debounceTimer) clearTimeout(debounceTimer);

        debounceTimer = setTimeout(() => commitFinal(pendingFinal), DEBOUNCE_MS);

      } else {

        interim += raw;

      }

    }

    // í™”ë©´ì—” í•­ìƒ "í™•ì • ëˆ„ì  + ì§„í–‰ì¤‘/ëŒ€ê¸°ì¤‘" í‘œì‹œ

    setScreen(finalText + (interim || pendingFinal));

  };



  r.onstart = () => { state.textContent="ğŸ¤ ì¸ì‹ ì¤‘"; toggle.textContent="â¸ï¸ ì¤‘ì§€"; toggle.className="danger"; };

  r.onend = () => {

    if (recognizing) { try{ r.start(); }catch{} }

    else { state.textContent="ëŒ€ê¸°"; toggle.textContent="ğŸ™ï¸ ì‹œì‘"; toggle.className="primary"; }

  };



  toggle.onclick = async () => {

    if (!recognizing) {

      try {

        const s = await navigator.mediaDevices.getUserMedia({audio:true});

        s.getTracks().forEach(t=>t.stop());

      } catch {

        alert("ë§ˆì´í¬ ê¶Œí•œ í•„ìš”");

        return;

      }

      recognizing = true; r.start();

    } else {

      recognizing = false; r.stop();

    }

  };



  clearBtn.onclick = () => {

    finalText=""; lastShown=""; pendingFinal="";

    if (debounceTimer) { clearTimeout(debounceTimer); debounceTimer=null; }

    setScreen("");

  };



  copyBtn.onclick = async () => {

    try {

      await navigator.clipboard.writeText(screen.textContent);

      state.textContent="ë³µì‚¬ë¨";

      setTimeout(()=> state.textContent = recognizing ? "ğŸ¤ ì¸ì‹ ì¤‘" : "ëŒ€ê¸°", 900);

    } catch { alert("ë³µì‚¬ ì‹¤íŒ¨"); }

  };

})();

</script>

</body>

</html>