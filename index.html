<!doctype html>

<html lang="ko">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>실시간 한국어 자막 (타자기 스타일)</title>

  <style>

    :root { --fs: 22px; }

    body { margin:0; background:#111; color:#eee; font:var(--fs)/1.6 "Noto Sans KR",sans-serif; }

    header { padding:10px; border-bottom:1px solid #444; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    button { padding:6px 14px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }

    button.primary { background:#4da3ff; color:#000; }

    button.danger  { background:#ff4d6d; color:#000; }

    #screen { padding:12px; height:80vh; overflow-y:auto; white-space:pre-wrap; }

    #state { margin-left:auto; color:#aaa; }

  </style>

</head>

<body>

  <header>

    <button id="toggle" class="primary">🎙️ 시작</button>

    <button id="clear">🧹 지우기</button>

    <button id="copy">📋 복사</button>

    <span id="state">대기</span>

  </header>



  <div id="screen"></div>



<script>

(() => {

  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!Rec) {

    document.body.innerHTML = "<p style='padding:16px'>❌ 크롬/삼성 인터넷 브라우저에서 실행해주세요.</p>";

    return;

  }



  const r = new Rec();

  r.lang = "ko-KR";

  r.continuous = true;

  r.interimResults = true;



  const toggle = document.getElementById("toggle");

  const clearBtn= document.getElementById("clear");

  const copyBtn = document.getElementById("copy");

  const state   = document.getElementById("state");

  const screen  = document.getElementById("screen");



  let recognizing = false;



  // 화면에 append-only 텍스트 노드

  const tape = document.createTextNode("");

  screen.appendChild(tape);



  // ===== 타자기 버퍼 =====

  let buffer = "";            // 새로 들어온 글자들

  let typingTimer = null;     // 타자기 출력 타이머

  const BUFFER_DELAY_MS = 600; // 입력 받고 기다리는 시간

  const TYPING_INTERVAL = 120; // 글자마다 출력 텀(ms)



  function startTyping(){

    if (typingTimer) return;

    typingTimer = setInterval(()=>{

      if (buffer.length>0){

        tape.data += buffer[0];

        buffer = buffer.slice(1);

        screen.scrollTop = screen.scrollHeight;

      } else {

        clearInterval(typingTimer);

        typingTimer = null;

      }

    }, TYPING_INTERVAL);

  }



  let bufferDelayTimer = null;

  function addToBuffer(text){

    if (!text) return;

    buffer += text;

    if (bufferDelayTimer) clearTimeout(bufferDelayTimer);

    bufferDelayTimer = setTimeout(()=>{

      startTyping();

    }, BUFFER_DELAY_MS);

  }



  // ===== Speech Recognition 이벤트 =====

  r.onresult = (e) => {

    let interim = "";

    let finals  = [];



    for (let i=e.resultIndex; i<e.results.length; i++){

      const seg = e.results[i][0].transcript;

      if (e.results[i].isFinal) finals.push(seg);

      else interim += seg;

    }



    if (interim) {

      addToBuffer(interim);

    }

    if (finals.length){

      const raw = finals[finals.length-1];

      addToBuffer(" " + raw + " ");

    }

  };



  r.onstart = () => { state.textContent="🎤 인식 중"; toggle.textContent="⏸️ 중지"; toggle.className="danger"; };

  r.onend = () => {

    if (recognizing) { try { r.start(); } catch {} }

   