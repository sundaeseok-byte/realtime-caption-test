<!doctype html>

<html lang="ko">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>실시간 한국어 자막 (중복 방지 포함)</title>

  <style>

    body { margin:0; background:#111; color:#eee; font:18px/1.6 "Noto Sans KR",sans-serif; }

    header { padding:10px; border-bottom:1px solid #444; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    button { padding:6px 12px; border-radius:6px; border:none; cursor:pointer; }

    button.primary { background:#4da3ff; color:#000; }

    button.danger { background:#ff4d6d; color:#000; }

    #screen { padding:12px; height:75vh; overflow-y:auto; white-space:pre-wrap; }

    #state { margin-left:auto; color:#aaa; }

  </style>

</head>

<body>

  <header>

    <button id="toggle" class="primary">🎙️ 시작</button>

    <button id="clear">🧹 지우기</button>

    <button id="copy">📋 복사</button>

    <span id="state">대기</span>

  </header>

  <div id="screen"></div>



<script>

(() => {

  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!Rec) {

    document.body.innerHTML = "<p style='padding:16px'>❌ 크롬/삼성 인터넷 브라우저를 사용해주세요.</p>";

    return;

  }



  const r = new Rec();

  r.lang = "ko-KR";

  r.continuous = true;

  r.interimResults = true;



  let recognizing = false;

  const toggle = document.getElementById("toggle");

  const clearBtn = document.getElementById("clear");

  const copyBtn = document.getElementById("copy");

  const state = document.getElementById("state");

  const screen = document.getElementById("screen");



  let finalText = "";

  let recentFinals = []; // 최근 확정 문장 기억

  const MAX_RECENT = 10;



  function alreadyShown(line){

    if (!line) return true;

    if (recentFinals.includes(line)) return true;

    recentFinals.push(line);

    if (recentFinals.length > MAX_RECENT) recentFinals.shift();

    return false;

  }



  r.onresult = (e) => {

    let interim = "";

    for (let i=e.resultIndex; i<e.results.length; i++) {

      const txt = e.results[i][0].transcript.trim();

      if (e.results[i].isFinal) {

        if (!alreadyShown(txt)) {

          finalText += txt + " ";

        }

      } else {

        interim += txt;

      }

    }

    screen.textContent = finalText + interim;

    screen.scrollTop = screen.scrollHeight;

  };



  r.onstart = () => { state.textContent="🎤 인식 중"; toggle.textContent="⏸️ 중지"; toggle.className="danger"; };

  r.onend = () => {

    if (recognizing) { try{ r.start(); }catch{} }

    else { state.textContent="대기"; toggle.textContent="🎙️ 시작"; toggle.className="primary"; }

  };



  toggle.onclick = async () => {

    if (!recognizing) {

      try { 

        const s = await navigator.mediaDevices.getUserMedia({audio:true}); 

        s.getTracks().forEach(t=>t.stop()); 

      } catch(e){ 

        alert("마이크 권한 필요"); 

        return; 

      }

      recognizing = true; 

      r.start();

    } else { 

      recognizing = false; 

      r.stop(); 

    }

  };



  clearBtn.onclick = () => { finalText=""; recentFinals=[]; screen.textContent=""; };

  copyBtn.onclick = async () => {

    try { 

      await navigator.clipboard.writeText(screen.textContent); 

      state.textContent="복사됨"; 

      setTimeout(()=> state.textContent=recognizing?"🎤 인식 중":"대기",800); 

    }

    catch { alert("복사 실패"); }

  };

})();

</script>

</body>

</html>