<!doctype html>

<html lang="ko">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>ì‹¤ì‹œê°„ í•œêµ­ì–´ ìë§‰ (ëˆ„ì /ìµœì í™”)</title>

  <style>

    body { margin:0; font-family:sans-serif; background:#111; color:#eee; }

    header { padding:10px; border-bottom:1px solid #444; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    button { padding:6px 12px; border-radius:6px; border:none; cursor:pointer; }

    button.primary { background:#4da3ff; color:#000; }

    button.danger { background:#ff4d6d; color:#000; }

    #screen { padding:12px; height:70vh; overflow-y:auto; white-space:pre-wrap; }

    #live { opacity:.6; font-style:italic; min-height:24px; }

  </style>

</head>

<body>

  <header>

    <button id="toggle" class="primary">ğŸ™ï¸ ì‹œì‘</button>

    <button id="clear">ğŸ§¹ ì§€ìš°ê¸°</button>

    <button id="copy">ğŸ“‹ ë³µì‚¬</button>

    <button id="save">ğŸ’¾ ì €ì¥</button>

    <span id="state">ëŒ€ê¸°</span>

  </header>

  <div id="live"></div>

  <div id="screen"></div>



<script>

(() => {

  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!Rec) {

    document.body.innerHTML = "<p>âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í¬ë¡¬/ì‚¼ì„± ì¸í„°ë„·ì„ ì‚¬ìš©í•˜ì„¸ìš”.</p>";

    return;

  }



  const r = new Rec();

  r.lang = "ko-KR";

  r.continuous = true;

  r.interimResults = true;



  let recognizing = false;

  let live = document.getElementById("live");

  let screen = document.getElementById("screen");

  let toggle = document.getElementById("toggle");

  let state = document.getElementById("state");



  // ì¹¨ë¬µ íƒ€ì´ë¨¸

  let silenceTimer = null;

  function resetSilenceTimer(finalText) {

    if (silenceTimer) clearTimeout(silenceTimer);

    silenceTimer = setTimeout(() => {

      if (finalText && finalText.trim().length > 2) {

        addLine(finalText.trim());

        live.textContent = "";

      }

    }, 1200); // 1.2ì´ˆ ì¹¨ë¬µ ì‹œ í™•ì •

  }



  function addLine(text){

    const line = document.createElement("div");

    line.textContent = text;

    screen.append(line);

    screen.scrollTop = screen.scrollHeight;

  }



  r.onresult = (e) => {

    let interim = "";

    for (let i=e.resultIndex; i<e.results.length; i++) {

      let txt = e.results[i][0].transcript;

      if (e.results[i].isFinal) {

        if (txt.trim().length > 2) addLine(txt.trim());

        live.textContent = "";

      } else {

        interim += txt;

      }

    }

    if (interim) {

      live.textContent = interim;

      resetSilenceTimer(interim);

    }

  };



  r.onstart = () => { state.textContent = "ğŸ¤ ì¸ì‹ ì¤‘"; toggle.textContent = "â¸ï¸ ì¤‘ì§€"; toggle.className="danger"; };

  r.onend = () => {

    if (recognizing) { try{ r.start(); }catch{} }

    else { state.textContent = "ëŒ€ê¸°"; toggle.textContent = "ğŸ™ï¸ ì‹œì‘"; toggle.className="primary"; }

  };

  r.onerror = (e) => { addLine("(ì˜¤ë¥˜: "+e.error+")"); };



  toggle.onclick = async () => {

    if (!recognizing) {

      try {

        const s = await navigator.mediaDevices.getUserMedia({ audio:true });

        s.getTracks().forEach(t=>t.stop());

      } catch(e){ addLine("(ë§ˆì´í¬ ê¶Œí•œ í•„ìš”)"); return; }

      recognizing = true;

      r.start();

    } else {

      recognizing = false;

      r.stop();

    }

  };



  document.getElementById("clear").onclick = () => { screen.textContent=""; live.textContent=""; };

  document.getElementById("copy").onclick = async () => {

    try {

      await navigator.clipboard.writeText(screen.textContent);

      state.textContent="ë³µì‚¬ë¨"; setTimeout(()=> state.textContent="ì¸ì‹ ì¤‘",1000);

    } catch { alert("ë³µì‚¬ ì‹¤íŒ¨"); }

  };

  document.getElementById("save").onclick = () => {

    const blob = new Blob([screen.textContent], {type:"text/plain"});

    const a = document.createElement("a");

    a.href = URL.createObjectURL(blob);

    a.download = "subtitle-"+Date.now()+".txt";

    a.click();

    URL.revokeObjectURL(a.href);

  };

})();

</script>

</body>

</html>