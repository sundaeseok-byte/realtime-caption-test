<!doctype html>

<html lang="ko">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>ì‹¤ì‹œê°„ í•œêµ­ì–´ ìë§‰ (append-only Â· ëŠë¦° ìŠ¤íŠ¸ë¦¬ë°)</title>

  <style>

    :root { --fs: 22px; }

    body { margin:0; background:#111; color:#eee; font:var(--fs)/1.6 "Noto Sans KR",sans-serif; }

    header { padding:10px; border-bottom:1px solid #444; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    button { padding:6px 14px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }

    button.primary { background:#4da3ff; color:#000; }

    button.danger  { background:#ff4d6d; color:#000; }

    #screen { padding:12px; height:80vh; overflow-y:auto; white-space:pre-wrap; }

    #state { margin-left:auto; color:#aaa; }

    .group { display:flex; gap:6px; align-items:center; }

    .pill  { font-size:12px; color:#9aa3ad; }

  </style>

</head>

<body>

  <header>

    <button id="toggle" class="primary">ğŸ™ï¸ ì‹œì‘</button>

    <button id="clear">ğŸ§¹ ì§€ìš°ê¸°</button>

    <button id="copy">ğŸ“‹ ë³µì‚¬</button>



    <div class="group" aria-label="ê¸€ì í¬ê¸° ì¡°ì ˆ">

      <button id="smaller" title="ê¸€ì ì‘ê²Œ">Aâˆ’</button>

      <button id="bigger"  title="ê¸€ì í¬ê²Œ">A+</button>

      <span id="fsLabel" class="pill"></span>

    </div>



    <span id="state">ëŒ€ê¸°</span>

  </header>



  <div id="screen"></div>



<script>

(() => {

  /* ===== ê¸€ì í¬ê¸° ===== */

  const FONT_MIN=16, FONT_MAX=64, STEP=2;

  const fsLabel = document.getElementById("fsLabel");

  let curFs = Number(localStorage.getItem("subtitle_fs_px") || 22);

  function applyFs(px){

    curFs = Math.min(FONT_MAX, Math.max(FONT_MIN, px));

    document.documentElement.style.setProperty("--fs", curFs + "px");

    fsLabel.textContent = `${curFs}px`;

    localStorage.setItem("subtitle_fs_px", String(curFs));

  }

  applyFs(curFs);

  document.getElementById("smaller").onclick = () => applyFs(curFs - STEP);

  document.getElementById("bigger").onclick  = () => applyFs(curFs + STEP);



  /* ===== ìŒì„± ì¸ì‹ ===== */

  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!Rec) {

    document.body.innerHTML = "<p style='padding:16px'>âŒ í¬ë¡¬/ì‚¼ì„± ì¸í„°ë„· ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>";

    return;

  }



  const r = new Rec();

  r.lang = "ko-KR";

  r.continuous = true;

  r.interimResults = true;

  r.maxAlternatives = 1;



  const toggle = document.getElementById("toggle");

  const clearBtn= document.getElementById("clear");

  const copyBtn = document.getElementById("copy");

  const state   = document.getElementById("state");

  const screen  = document.getElementById("screen");



  let recognizing = false;



  // í™”ë©´ì— ì´ë¯¸ "ë¶™ì—¬ ì“´ í…ìŠ¤íŠ¸"

  let written = "";                 // í™”ë©´ì— ì‹¤ì œ ì¶œë ¥ëœ ë¬¸ìì—´(append-only)

  // í˜„ì¬ ì¸ì‹ ì„¸ì…˜ì—ì„œ ë¸Œë¼ìš°ì €ê°€ ë§Œë“¤ì–´ë‚´ëŠ” ì§„í–‰ì¤‘ ë¬¸ìì—´(ë®ì–´ì“°ê¸°ìš© ë‚´ë¶€ ìƒíƒœ)

  let currentStream = "";           // interim ëˆ„ì  ìŠ¤ëƒ…ìƒ·(ë¸Œë¼ìš°ì € ê´€ì )

  // ìŠ¤ë¡œí‹€ë§

  const THROTTLE_MS = 220;          // í‘œì‹œ ì†ë„: 0.22ì´ˆ ê°„ê²©

  let lastFlushAt = 0;

  let queuedDelta = "";             // ë‹¤ìŒ í”ŒëŸ¬ì‹œ ë•Œ ë¶™ì¼ ë¸íƒ€



  function commonPrefixLen(a,b){

    const n = Math.min(a.length, b.length);

    let i=0;

    while (i<n && a.charCodeAt(i)===b.charCodeAt(i)) i++;

    return i;

  }



  // "ë¸Œë¼ìš°ì €ê°€ ë§Œë“  ìƒˆ interim ë¬¸ìì—´"ì„ í™”ë©´ì— "ì¦ë¶„"ìœ¼ë¡œ ë°˜ì˜

  function scheduleAppendFrom(newStream){

    // ì´ì „ ìŠ¤íŠ¸ë¦¼ê³¼ì˜ ê³µí†µ ì ‘ë‘ì‚¬ ì´í›„ ë¶€ë¶„ë§Œ ë¸íƒ€ë¡œ ì¶”ì¶œ

    const cpl = commonPrefixLen(currentStream, newStream);

    const delta = newStream.slice(cpl);

    if (!delta) return;

    queuedDelta += delta;



    const now = performance.now();

    const due = Math.max(0, THROTTLE_MS - (now - lastFlushAt));

    if (!flushTimer) {

      flushTimer = setTimeout(flush, due);

    }

    currentStream = newStream; // ë‚´ë¶€ ìŠ¤íŠ¸ë¦¼ ìŠ¤ëƒ…ìƒ· ê°±ì‹ (í™”ë©´ì€ append-only)

  }



  let flushTimer = null;

  function flush(){

    if (queuedDelta) {

      // ì¤„ë°”ê¿ˆ ì—†ì´ ì´ì–´ì“°ê¸°, ê³µë°±ì€ ìˆëŠ” ê·¸ëŒ€ë¡œ

      written += queuedDelta;

      screen.textContent = written;

      screen.scrollTop = screen.scrollHeight;

      queuedDelta = "";

    }

    lastFlushAt = performance.now();

    flushTimer = null;

  }



  r.onresult = (e) => {

    // ìƒˆë¡œ ë“¤ì–´ì˜¨ ì´ë²¤íŠ¸ì—ì„œ interimê³¼ finalì„ ìŠ¤ìº”

    let latestInterim = null;

    let gotFinal = false;



    for (let i=e.resultIndex; i<e.results.length; i++){

      const seg = e.results[i][0].transcript;

      if (e.results[i].isFinal) {

        gotFinal = true;

        // append-only ì •ì±…: finalë„ "ìˆ˜ì • ì—†ì´" ë¸íƒ€ë§Œ ì¶”ê°€ë˜ë„ë¡

        // ë¸Œë¼ìš°ì €ê°€ finalë¡œ í™•ì •í–ˆë”ë¼ë„, ìš°ë¦¬ëŠ” ì´ë¯¸ interimì—ì„œ appendí•´ ì™”ìœ¼ë¯€ë¡œ

        // ë³„ë„ ìˆ˜ì •/ë®ì–´ì“°ê¸° ì—†ì´ "í˜„ì¬ stream"ë§Œ ë¦¬ì…‹í•˜ê³  ë‹¤ìŒ ë¬¸ì¥ ëŒ€ë¹„

      } else {

        latestInterim = (latestInterim ?? "") + seg;

      }

    }



    if (latestInterim !== null) {

      // í˜„ì¬ ì„¸ì…˜ì˜ ìƒˆ interim ì „ì²´ ë¬¸ìì—´ì„ ê¸°ì¤€ìœ¼ë¡œ ë¸íƒ€ë§Œ ì´ì–´ë¶™ì„

      scheduleAppendFrom(latestInterim);

    }



    if (gotFinal) {

      // finalì´ ì˜¤ë©´ ë¸Œë¼ìš°ì € ë‚´ë¶€ ìŠ¤íŠ¸ë¦¼ì€ ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ë°”ë€Œë¯€ë¡œ,

      // ìš°ë¦¬ëŠ” í™”ë©´ì„ ê±´ë“œë¦¬ì§€ ì•Šê³  "ìŠ¤íŠ¸ë¦¼ ìŠ¤ëƒ…ìƒ·"ë§Œ ë¦¬ì…‹í•œë‹¤.

      currentStream = "";

    }

  };



  r.onstart = () => { state.textContent="ğŸ¤ ì¸ì‹ ì¤‘"; toggle.textContent="â¸ï¸ ì¤‘ì§€"; toggle.className="danger"; };

  r.onend = () => {

    // ì¸ì‹ì´ ëŠê²¨ë„ ìë™ ì¬ì‹œì‘

    if (recognizing) { try { r.start(); } catch {} }

    else { state.textContent="ëŒ€ê¸°"; toggle.textContent="ğŸ™ï¸ ì‹œì‘"; toggle.className="primary"; }

  };

  r.onerror = (e) => {

    // ì˜¤ë¥˜ë„ append-onlyë¡œ í‘œì‹œ

    written += `(ì˜¤ë¥˜: ${e.error}) `;

    screen.textContent = written;

  };



  toggle.onclick = async () => {

    if (!recognizing) {

      // ë§ˆì´í¬ ê¶Œí•œ ì˜ˆì—´

      try {

        const s = await navigator.mediaDevices.getUserMedia({audio:true});

        s.getTracks().forEach(t=>t.stop());

      } catch {

        alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");

        return;

      }

      recognizing = true; r.start();

    } else {

      recognizing = false; r.stop();

    }

  };



  clearBtn.onclick = () => {

    written=""; currentStream=""; queuedDelta="";

    if (flushTimer) { clearTimeout(flushTimer); flushTimer=null; }

    screen.textContent="";

  };



  copyBtn.onclick = async () => {

    try {

      await navigator.clipboard.writeText(screen.textContent);

      state.textContent="ë³µì‚¬ë¨";

      setTimeout(()=> state.textContent = recognizing ? "ğŸ¤ ì¸ì‹ ì¤‘" : "ëŒ€ê¸°", 900);

    } catch { alert("ë³µì‚¬ ì‹¤íŒ¨"); }

  };

})();

</script>

</body>

</html>